name: Build App

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true

      - name: Install Android SDK 35
        uses: android-actions/setup-android@v3
        with:
          packages: platform-tools platforms;android-35 build-tools;35.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install libvips dependencies
        run: sudo apt-get update && sudo apt-get install -y libvips42 libvips-dev

      - name: Install Dependencies
        run: npm install

      - name: Prepare Web Assets
        run: |
          # Since the app loads a remote URL, we just need a placeholder www folder
          # to satisfy Capacitor's build requirements.
          mkdir -p www
          echo "<html><body><h1>Loading Remote App...</h1></body></html>" > www/index.html

      - name: Create google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          python3 -c "
          import os, json, sys, base64
          content = os.environ['GOOGLE_SERVICES_JSON']
          try:
            json.loads(content)
          except:
            try:
              decoded = base64.b64decode(content).decode('utf-8')
              json.loads(decoded)
              content = decoded
              print('Auto-decoded Base64 secret')
            except:
              print('::error::The GOOGLE_SERVICES_JSON secret is not valid JSON.')
              sys.exit(1)
          
          with open('android/app/google-services.json', 'w') as f:
            f.write(content)
          "

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK
        run: |
          # Force clean Gradle cache to fix "Failed to create Jar file" error
          rm -rf ~/.gradle/caches/
          
          cd android
          chmod +x gradlew
          ./gradlew clean assembleDebug --no-daemon --no-parallel --max-workers=1 --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-CelyaVox-Mobile-Android
          path: android/app/build/outputs/apk/debug/app-debug.apk

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Prepare Web Assets
        run: |
          # Since the app loads a remote URL, we just need a placeholder www folder
          # to satisfy Capacitor's build requirements.
          mkdir -p www
          echo "<html><body><h1>Loading Remote App...</h1></body></html>" > www/index.html

      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: ios/App/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/App/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Create GoogleService-Info.plist
        env:
          GOOGLE_SERVICE_INFO_PLIST: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
        run: python3 -c "import os; f = open('ios/App/App/GoogleService-Info.plist', 'w'); f.write(os.environ['GOOGLE_SERVICE_INFO_PLIST']); f.close()"

      - name: Sync Capacitor
        run: |
          npx cap copy ios
          npx cap update ios --no-install
          cd ios/App
          pod install --repo-update

      - name: Build iOS (Simulator)
        run: |
          cd ios
          xcodebuild -workspace App/App.xcworkspace -scheme App -sdk iphonesimulator -configuration Debug clean build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

      - name: Upload iOS App
        uses: actions/upload-artifact@v4
        with:
          name: app-CelyaVox-Mobile-iOS
          path: ios/App/build/Debug-iphonesimulator/App.app
